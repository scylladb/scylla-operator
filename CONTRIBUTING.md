# Contributing to Scylla Operator

## Initial Setup

### Fork the repository

Follow GitHub's official documentation on [forking a repository](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/fork-a-repo).

## Development

To add a feature or to make a bug fix, you will need to create a branch in your fork and then submit a pull request (PR) from the branch.
A subset of useful commands:
* `make build` - build project binaries
* `make test-unit` - run unit tests
* `make update` - run all code generators
* `make verify` - run a preconfigured set of linters and verify that all autogenerated files are up to date

Check `make help` for more.

### Dependencies

Most of the dependencies are managed by Go modules. Some Makefile targets require additional tools to be installed, and
it's up to the developer to ensure they are available in the environment:

- [yq](https://github.com/mikefarah/yq)
- [jq](https://github.com/jqlang/jq)
- [helm](https://github.com/helm/helm)
- [golangci-lint](https://github.com/golangci/golangci-lint)
- [operator-sdk](https://sdk.operatorframework.io/docs/installation/)
  (**Note:** Until [#6978](https://github.com/operator-framework/operator-sdk/pull/6978) is merged and released, you
  need to use `operator-sdk` from the PR branch; `quay.io/scylladb/scylla-operator-images:golang-1.25` image has it preinstalled)
- [ginkgo](https://onsi.github.io/ginkgo/#getting-started) - for running envtests.
- [podman](https://podman.io/get-started) - for building and running container images.
- [kind](https://kind.sigs.k8s.io/docs/user/quick-start/) - for running local Kubernetes clusters for E2E tests.

### Running E2E tests locally

We use [Kind](https://kind.sigs.k8s.io/) for basic local testing. We rely on a kind with rootless Podman setup, so before
proceeding, make sure your host system is configured accordingly to [Kind Podman rootless guide](https://kind.sigs.k8s.io/docs/user/rootless/).

There's a Makefile target to create a Kind cluster with a local registry configured so we can use locally built images.
To set up the Kind cluster, run:

```bash
make kind-setup
```

You can then run the E2E tests (`kind-fast` suite) with:

```bash
make test-e2e-kind
```

The tests will run against the Kind cluster created in the previous step. A pod running the tests will be created in the `e2e` namespace.
A ScyllaDB Operator image based on the local code will be built and loaded into the Kind cluster automatically.

You can skip building if you choose the Scylla Operator image to be used in the tests by setting the `SO_IMAGE` environment variable. For example:

```bash
SO_IMAGE="quay.io/scylladb/scylla-operator:latest" make test-e2e-kind
``` 

Please note that the image must be accessible from within the Kind cluster. If you're using a locally built image, you should:

1. Run `make kind-setup` first. 
2. Tag your image with `localhost:5001/your-image-name:tag`. 
3. Push it to the local registry: `podman push --tls-verify=false localhost:5001/your-image-name:tag`.

To run specific test cases, use the `SO_FOCUS` environment variable (it accepts [a regexp filtering ginkgo test cases](https://onsi.github.io/ginkgo/#description-based-filtering)). For example: 

```bash
SO_FOCUS=".*TestCaseName.*" make test-e2e-kind
```

If you ever need to start from a clean state, you can delete the Kind cluster with:

```bash
make kind-teardown
```

## Coding convention

Follow these guidelines for writing and structuring your code:
* [Effective Go](https://go.dev/doc/effective_go)
* [Go Code Review Comments](https://go.dev/wiki/CodeReviewComments)
* [API changes](https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api_changes.md)
* [API conventions](https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md)
* [ScyllaDB Operator API design conventions](./API_CONVENTIONS.md)

In cases where the existing code doesn't fully follow these conventions, try to be consistent with what's already there. Make sure to familiarize yourself with these resources before making changes.

## Enhancement proposals

For significant features or API changes, you might be required to prepare an enhancement proposal beforehand, as these usually involve broader discussions. If unsure, please consult the [maintainers of the project](https://github.com/scylladb/scylla-operator/blob/master/OWNERS) to learn if your contribution falls into these categories before you start working on the implementation.  
For further details, see [Enhancement Proposals directory](https://github.com/scylladb/scylla-operator/tree/master/enhancements).

## Submitting a Pull Request

Once you have implemented the feature or bug fix in your branch, open a PR to the upstream repository. Before doing so, ensure the following:
- Unit tests are included.
- End-to-end tests are passing.
- Your commit history is clean.

### Commit History

To maintain a clean commit history, aim for a minimal number of logical commits. Typically, this means a single commit that contains all the changes, with a separate commit for autogenerated parts.

### Commits and PRs

The **subject line** of your commit message **and the PR title** should summarize the change in one clear sentence that would be meaningful to a user of the Operator. The sentence should be **written in the imperative**, i.e. written as if giving a command or instruction, e.g. "Add support for XYZ". A properly formed Git commit subject line should always be able to complete the sentence "If applied, this commit will...", e.g.  "If applied, this commit will **Add support for XYZ**".
Changelog entries are verbatim PR titles, so make them concise yet informative.

Further details should be added after a blank line. Explain why the change was necessary, not just what was changed. In the general case, extensive descriptions are well-received. Comparing the behavior before and after the change is especially helpful. Write the message with the mindset that youâ€™ll need to revisit the code in the future.
If your PR fixes an issue, include "Resolves #1234" in the description, replacing "1234" with the issue number.

```
**Description of your changes:**
Add new XYZ field to ScyllaCluster CRD.
The new field allows for configuration of ZYX feature of ScyllaDB.
<more details>
API change was discussed in the following enhancement: <link>.

**Which issue is resolved by this Pull Request:**
Resolves #1234 
```

### Code review

Refer to [The Standard of Code Review](https://github.com/golang/go/wiki/CodeReviewComments) for best practices when conducting peer reviews or responding to feedback.

### Submitting

After addressing the review feedback, squash your changes into the original commits. Avoid adding new commits. Your PR should always be in a mergeable state.

## Maintenance

### Configuring Renovate

We're using [Renovate](https://docs.renovatebot.com/) for automatic dependency updates of some components.
If you want to modify Renovate's configuration, edit the `renovate.json` file in the repository root. You can verify
your changes by running Renovate locally using the following command: `./hack/check-renovate.sh`. If there are any
updates that you expect Renovate to make, but the script does not report them, please adjust your configuration accordingly.
