#!/usr/bin/env bash
#
# Copyright (C) 2026 ScyllaDB
#

set -euxEo pipefail
shopt -s inherit_errexit

# This script generates a Go package containing in-tree copies of required prometheus-operator exports.
# The purpose of creating the in-tree copies is to avoid depending on prometheus-operator modules directly to reduce unnecessary dependency bloat.
# It extracts the prometheus-operator version from assets/metadata/metadata.yaml

readonly script_dir="$( realpath $( dirname "${BASH_SOURCE[0]}" ) )"
readonly repo_root="${script_dir}/../../"

source "${script_dir}/../lib/assets.sh"

# generate_pkg_operator_defaults generates the pkg/operator/defaults.go file with the PrometheusCompatibilityMatrix variable.
# Arguments:
#   $1 - prometheus-operator root URL (e.g., https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.68.0)
#   $2 - output directory root
function generate_pkg_operator_defaults() {
  local prometheus_operator_defaults_url="${1}/pkg/operator/defaults.go"
  local output_file="${2}/pkg/operator/defaults.go"

  # Fetch the defaults.go content
  local defaults_content
  defaults_content=$(curl -sSL "${prometheus_operator_defaults_url}")
  if [[ -z "${defaults_content}" ]]; then
    echo "Error: Could not fetch ${prometheus_operator_defaults_url}" >&2
    return 1
  fi

  # Extract the Prometheus compatibility matrix.
  local prometheus_compatibility_matrix
  prometheus_compatibility_matrix=$(echo "${defaults_content}" | sed -n '/PrometheusCompatibilityMatrix = \[\]string{/,/^[[:space:]]*}/p')

  if [[ -z "${prometheus_compatibility_matrix}" ]]; then
    echo "Error: Could not find PrometheusCompatibilityMatrix in ${prometheus_operator_defaults_url}" >&2
    return 1
  fi

  mkdir -p "$(dirname "${output_file}")"

  cat > "${output_file}" << EOF
// Code generated by hack/generate-in-tree-prometheus-operator-exports.sh. DO NOT EDIT.
//
// Copyright 2020 The prometheus-operator Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package operator

// Extracted from ${prometheus_operator_defaults_url}.
// PrometheusCompatibilityMatrix is a slice of Prometheus versions that Prometheus Operator is compatible with.
var PrometheusCompatibilityMatrix = []string{
EOF

  # Extract just the version strings and format them
  echo "${prometheus_compatibility_matrix}" | grep -o '"v[0-9]\+\.[0-9]\+\.[0-9]\+"' | while read -r version; do
    echo "	${version}," >> "${output_file}"
  done

  echo "}" >> "${output_file}"
}

if [[ "$#" -ne 1 ]]; then
  echo -e "Invalid arguments.\nUsage: ${0} <output_dir>" >&2
  exit 1
fi

readonly output_dir="${1}"

readonly prometheus_operator_version=$(get-config ".thirdParty.prometheusOperator.version")
readonly prometheus_operator_root_url="https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v${prometheus_operator_version}"

generate_pkg_operator_defaults "${prometheus_operator_root_url}" "${output_dir}"
