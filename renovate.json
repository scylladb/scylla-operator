{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended"
  ],
  "enabledManagers": [
    "custom.regex",
    "gomod",
    "poetry"
  ],
  "schedule": [
    "before 5am on monday"
  ],
  "labels": [
    "kind/dependency-bump",
    "priority/important-longterm"
  ],
  "packageRules": [
    {
      "description": "Image references in assets/config/config.yaml should be updated every weekday",
      "matchDatasources": [
        "docker"
      ],
      "matchFileNames": [
        "assets/config/config.yaml"
      ],
      "schedule": [
        "before 5am every weekday"
      ]
    },
    {
      "description": "scylla-manager and scylla-manager-agent must be updated together",
      "matchDepNames": [
        "scylla-manager",
        "scylla-manager-agent"
      ],
      "groupName": "scylla-manager"
    },
    {
      "description": "go.mod dependencies should be updated together",
      "matchManagers": [
        "gomod"
      ],
      "postUpdateOptions": [
        "gomodTidy",
        "gomodVendor",
        "gomodUpdateImportPaths"
      ],
      "groupName": "gomod"
    },
    {
      "description": "go.mod dependencies that should not be updated (rule auto-generated by make update-renovate-config)",
      "matchPackageNames": [
        "github.com/gocql/gocql",
        "github.com/prometheus-operator/prometheus-operator/pkg/apis/monitoring",
        "github.com/prometheus-operator/prometheus-operator/pkg/client"
      ],
      "enabled": false
    },
    {
      "description": "Documentation dependencies should be updated together",
      "matchManagers": [
        "poetry"
      ],
      "matchFileNames": [
        "docs/pyproject.toml"
      ],
      "lockFileMaintenance": {
        "enabled": true
      },
      "groupName": "docs"
    },
    {
      "description": "Poetry version must be pinned to the one used in the container image",
      "matchPackageNames": [
        "poetry",
        "poetry-core"
      ],
      "matchFileNames": [
        "docs/pyproject.toml"
      ],
      "enabled": false
    },
    {
      "description": "Monitoring dependencies should be grouped and updated every weekday",
      "matchDepNames": [
        "scylladb/scylla-monitoring",
        "prometheus-operator"
      ],
      "groupName": "monitoring",
      "schedule": [
        "before 5am every weekday"
      ]
    },
    {
      "description": "Dockerfile base images should be updated every weekday",
      "matchDatasources": [
        "docker"
      ],
      "matchFileNames": [
        "Dockerfile"
      ],
      "schedule": [
        "before 5am every weekday"
      ]
    },
    {
      "matchManagers": [
        "regex"
      ],
      "matchDepNames": [
        "scylladb/scylla-monitoring"
      ],
      "addLabels": [
        "do-not-merge/hold"
      ],
      "prBodyNotes": [
        "### ⚠️ Manual Action Required",
        "Renovate has detected a new GitHub Release for `scylla-monitoring`, but cannot automatically update the Git submodule's commit and update sub-dependencies.",
        "",
        "**Please complete the following steps before merging:**",
        "1. Check out this branch locally.",
        "2. Update the submodule and sub-dependencies:",
        "   ```bash",
        "   cd submodules/github.com/scylladb/scylla-monitoring",
        "   git fetch --tags",
        "   git checkout tags/{{{newValue}}}",
        "   cd ../../../..",
        "   git add submodules/github.com/scylladb/scylla-monitoring",
        "   make update",
        "   git add .",
        "   git commit --amend && git push --force",
        "   ```",
        "3. Remove the `do-not-merge/hold` label."
      ]
    }
  ],
  "customManagers": [
    {
      "description": "Custom manager for dependencies defined in assets/config/config.yaml with Renovate annotations matching the regex.",
      "customType": "regex",
      "managerFilePatterns": [
        "/^assets/config/config\\.yaml$/"
      ],
      "matchStrings": [
        "#\\s*renovate:\\s*datasource=(?<datasource>\\S+)\\s+depName=(?<depName>\\S+)(\\s+packageName=(?<packageName>\\S+))?(\\s+registryUrl=(?<registryUrl>\\S+))?(\\s+versioning=(?<versioning>\\S+))?\\s*\\n\\s*\\S+:\\s*\"?(?<currentValue>[^@\"\\s]+)(?:@(?<currentDigest>sha256:[a-f0-9]+))?\"?"
      ]
    },
    {
      "description": "Custom manager for Dockerfile with Renovate annotations matching the regex.",
      "customType": "regex",
      "fileMatch": [
        "^Dockerfile$"
      ],
      "matchStrings": [
        "#\\s*renovate:\\s*datasource=(?<datasource>\\S+)\\s+depName=(?<depName>\\S+)(\\s+packageName=(?<packageName>\\S+))?(\\s+registryUrl=(?<registryUrl>\\S+))?(\\s+versioning=(?<versioning>\\S+))?\\s*\\nFROM\\s+\\S+:(?<currentValue>\\S+)"
      ]
    },
    {
      "description": "Custom manager for git submodules with Renovate annotations matching the regex.",
      "customType": "regex",
      "fileMatch": [
        "^\\.gitmodules$"
      ],
      "matchStrings": [
        "# renovate: datasource=(?<datasource>[a-z-]+) depName=(?<depName>[^\\s]+)\\s+branch = (?<currentValue>.*)"
      ]
    }
  ],
  "customDatasources": {
    "envtest": {
      "defaultRegistryUrlTemplate": "https://raw.githubusercontent.com/kubernetes-sigs/controller-tools/HEAD/envtest-releases.yaml",
      "format": "yaml",
      "transformTemplates": [
        "{ \"releases\": $map($keys(releases), function($v) { { \"version\": $v } }) }"
      ]
    }
  }
}
